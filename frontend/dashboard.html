<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/modern.css">
  <style>
    .page-header {
      margin-bottom: var(--space-xl);
    }

    .page-title {
      font-size: var(--text-3xl);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .page-subtitle {
      font-size: var(--text-base);
      color: var(--text-secondary);
      margin-top: var(--space-xs);
    }

    /* Compact Stats Bar */
    .stats-bar {
      display: flex;
      align-items: center;
      justify-content: space-around;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-md) var(--space-lg);
      margin-bottom: var(--space-lg);
    }

    .stats-bar-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .stats-bar-icon {
      font-size: var(--text-lg);
    }

    .stats-bar-value {
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-primary);
    }

    .stats-bar-label {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .stats-bar-divider {
      width: 1px;
      height: 32px;
      background: var(--border);
    }

    @media (max-width: 768px) {
      .stats-bar {
        flex-wrap: wrap;
        gap: var(--space-md);
      }
      .stats-bar-divider {
        display: none;
      }
      .stats-bar-item {
        flex: 1 1 45%;
        justify-content: center;
      }
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
    }

    .section-title {
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--text-primary);
    }

    .tournaments-section {
      margin-top: var(--space-xl);
    }

    /* Table improvements */
    .table-actions {
      display: flex;
      gap: var(--space-sm);
      justify-content: flex-end;
    }

    .btn-view {
      background: var(--success);
      color: white;
      border: none;
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-view:hover {
      background: #2DB14E;
      transform: translateY(-1px);
    }

    .btn-delete-small {
      background: var(--danger-light);
      color: var(--danger);
      border: none;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-delete-small:hover {
      background: var(--danger);
      color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .welcome-banner {
        padding: var(--space-lg);
      }

      .welcome-banner h2 {
        font-size: var(--text-xl);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Navigation Header -->
    <nav class="nav-header">
      <div class="nav-brand">
        <img src="images/billiard-icon.png" alt="CDBHS" class="nav-brand-logo" onerror="this.style.display='none';">
        <div class="nav-brand-text">
          <span class="nav-brand-title">CDBHS</span>
          <span class="nav-brand-subtitle">Joueurs et CompÃ©titions</span>
        </div>
      </div>

      <div class="nav-links">
        <a href="dashboard.html" class="nav-link active">
          <span class="nav-link-icon">ğŸ </span>
          Accueil
        </a>

        <div class="nav-dropdown admin-only">
          <button class="nav-link">
            <span class="nav-link-icon">ğŸ“</span>
            Fichiers
          </button>
          <div class="nav-dropdown-menu">
            <a href="players-list.html" class="nav-dropdown-item">
              <span>ğŸ‘¥</span> Joueurs
            </a>
            <a href="tournaments-list.html" class="nav-dropdown-item">
              <span>ğŸ†</span> Tournois jouÃ©s
            </a>
            <a href="tournois-list.html" class="nav-dropdown-item">
              <span>ğŸ“‹</span> Tournois IONOS
            </a>
            <a href="inscriptions-list.html" class="nav-dropdown-item">
              <span>âœï¸</span> Inscriptions IONOS
            </a>
            <a href="clubs.html" class="nav-dropdown-item">
              <span>ğŸ¢</span> Clubs
            </a>
            <div class="nav-dropdown-divider admin-only"></div>
            <a href="import-players.html" class="nav-dropdown-item admin-only">
              <span>ğŸ“¥</span> Import Joueurs
            </a>
            <a href="import-tournament.html" class="nav-dropdown-item admin-only">
              <span>ğŸ“¤</span> Import Tournoi
            </a>
            <a href="import-external.html" class="nav-dropdown-item admin-only">
              <span>ğŸ“‹</span> Import Inscriptions
            </a>
          </div>
        </div>

        <a href="rankings.html" class="nav-link">
          <span class="nav-link-icon">ğŸ“Š</span>
          Classements
        </a>

        <a href="generate-poules.html" class="nav-link">
          <span class="nav-link-icon">ğŸ¯</span>
          CompÃ©titions Ã  jouer
        </a>

        <a href="emailing.html" class="nav-link">
          <span class="nav-link-icon">âœ‰ï¸</span>
          Emailing
        </a>

        <div class="nav-dropdown admin-only">
          <button class="nav-link">
            <span class="nav-link-icon">âš™ï¸</span>
            ParamÃ¨tres
          </button>
          <div class="nav-dropdown-menu">
            <a href="settings.html" class="nav-dropdown-item">
              <span>âš™ï¸</span> Configuration
            </a>
            <a href="calendar.html" class="nav-dropdown-item">
              <span>ğŸ“…</span> Calendrier
            </a>
          </div>
        </div>

        <a href="#" id="logoutBtn" class="nav-link nav-logout">
          <span class="nav-link-icon">ğŸšª</span>
          DÃ©connexion
        </a>

        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
          <span class="theme-toggle-icon">ğŸŒ™</span>
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="page-container animate-fadeIn">
      <!-- Alerts -->
      <div id="errorMessage" class="alert alert-danger" style="display: none;">
        <span class="alert-icon">âš ï¸</span>
        <span id="errorText"></span>
      </div>
      <div id="successMessage" class="alert alert-success" style="display: none;">
        <span class="alert-icon">âœ…</span>
        <span id="successText"></span>
      </div>

      <!-- Compact Stats Bar -->
      <div class="stats-bar">
        <div class="stats-bar-item">
          <span class="stats-bar-icon">ğŸ‘¥</span>
          <span class="stats-bar-value" id="activePlayerCount">-</span>
          <span class="stats-bar-label">Joueurs actifs</span>
        </div>
        <div class="stats-bar-divider"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-icon">ğŸ†</span>
          <span class="stats-bar-value" id="tournamentCount">-</span>
          <span class="stats-bar-label">CompÃ©titions jouÃ©es</span>
        </div>
        <div class="stats-bar-divider"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-icon">ğŸ¯</span>
          <span class="stats-bar-value" id="cumulativeParticipants">-</span>
          <span class="stats-bar-label">Participants cumulÃ©s</span>
        </div>
      </div>

      <!-- Inscriptions saison en cours (green) -->
      <h4 id="inscSectionTitle" style="margin: 20px 0 10px 0; color: var(--text-secondary);">Inscriptions saison en cours</h4>
      <div class="stats-bar" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; margin-bottom: 16px;">
        <div class="stats-bar-item">
          <span class="stats-bar-value" id="inscTotalSeason" style="color: white;">-</span>
          <span class="stats-bar-label" style="color: rgba(255,255,255,0.9);">Total</span>
        </div>
        <div class="stats-bar-divider" style="background: rgba(255,255,255,0.3);"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-value" id="inscConvoquesSeason" style="color: white;">-</span>
          <span class="stats-bar-label" style="color: rgba(255,255,255,0.9);">ConvoquÃ©s</span>
        </div>
        <div class="stats-bar-divider" style="background: rgba(255,255,255,0.3);"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-value" id="inscForfaitsSeason" style="color: white;">-</span>
          <span class="stats-bar-label" style="color: rgba(255,255,255,0.9);">Forfaits</span>
        </div>
      </div>

      <!-- CompÃ©titions saison en cours (green) -->
      <h4 id="tournoiSectionTitle" style="margin: 20px 0 10px 0; color: var(--text-secondary);">CompÃ©titions saison en cours</h4>
      <div class="stats-bar" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; margin-bottom: 16px;">
        <div class="stats-bar-item">
          <span class="stats-bar-value" id="tournoiTotalSeason" style="color: white;">-</span>
          <span class="stats-bar-label" style="color: rgba(255,255,255,0.9);">Total</span>
        </div>
        <div class="stats-bar-divider" style="background: rgba(255,255,255,0.3);"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-value" id="tournoiUpcomingSeason" style="color: white;">-</span>
          <span class="stats-bar-label" style="color: rgba(255,255,255,0.9);">A venir</span>
        </div>
        <div class="stats-bar-divider" style="background: rgba(255,255,255,0.3);"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-value" id="tournoiPastSeason" style="color: white;">-</span>
          <span class="stats-bar-label" style="color: rgba(255,255,255,0.9);">PassÃ©s</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Actions Rapides</h3>
        </div>
        <div class="quick-actions">
          <a href="import-tournament.html" class="quick-action-card admin-only">
            <div class="quick-action-icon">ğŸ“¤</div>
            <span class="quick-action-label">Importer un Tournoi</span>
          </a>
          <a href="generate-poules.html" class="quick-action-card">
            <div class="quick-action-icon">ğŸ¯</div>
            <span class="quick-action-label">CompÃ©titions Ã  jouer</span>
          </a>
          <a href="rankings.html" class="quick-action-card">
            <div class="quick-action-icon">ğŸ“Š</div>
            <span class="quick-action-label">Voir les Classements</span>
          </a>
          <a href="calendar.html" class="quick-action-card">
            <div class="quick-action-icon">ğŸ“…</div>
            <span class="quick-action-label">Calendrier</span>
          </a>
          <a href="players-list.html" class="quick-action-card">
            <div class="quick-action-icon">ğŸ‘¥</div>
            <span class="quick-action-label">Joueurs</span>
          </a>
        </div>
      </div>

    </main>
  </div>

  <script>
    const API_URL = '/api';

    // Theme management
    function getPreferredTheme() {
      const stored = localStorage.getItem('theme');
      if (stored) return stored;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeIcon(theme);
    }

    function updateThemeIcon(theme) {
      const icon = document.querySelector('.theme-toggle-icon');
      if (icon) icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      setTheme(current === 'dark' ? 'light' : 'dark');
    }

    // Initialize theme
    setTheme(getPreferredTheme());

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and show/hide admin elements
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // Get season for a given date (Sept-Aug cycle)
    function getSeasonForDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load player counts
        const allPlayersResponse = await fetch(`${API_URL}/players`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (allPlayersResponse.status === 401 || allPlayersResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (allPlayersResponse.ok) {
          const allPlayers = await allPlayersResponse.json();
          const activePlayers = allPlayers.filter(p => p.is_active === 1);
          document.getElementById('activePlayerCount').textContent = activePlayers.length;
        }

        // Load tournaments (played)
        const tournamentsResponse = await fetch(`${API_URL}/tournaments`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (tournamentsResponse.status === 401 || tournamentsResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          document.getElementById('tournamentCount').textContent = tournaments.length;

          // Calculate cumulative participants (sum of all player_count from tournaments)
          const cumulativeParticipants = tournaments.reduce((sum, t) => sum + (parseInt(t.player_count, 10) || 0), 0);
          document.getElementById('cumulativeParticipants').textContent = cumulativeParticipants;
        }

        // Load inscriptions and tournois IONOS stats
        await loadInscriptionsStats();
        await loadTournoisStats();

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Load inscriptions stats (current season only)
    async function loadInscriptionsStats() {
      try {
        // Load inscriptions
        const inscResponse = await fetch(`${API_URL}/inscriptions`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // Load tournois for date reference
        const tournoisResponse = await fetch(`${API_URL}/inscriptions/tournois-ext`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (inscResponse.ok && tournoisResponse.ok) {
          const inscriptions = await inscResponse.json();
          const tournois = await tournoisResponse.json();

          // Create tournoi lookup by ID
          const tournoiMap = {};
          tournois.forEach(t => { tournoiMap[t.tournoi_id] = t; });

          // Current season stats
          const currentSeason = getSeasonForDate(new Date());
          const seasonInscriptions = inscriptions.filter(i => {
            const tournoi = tournoiMap[i.tournoi_id];
            if (!tournoi || !tournoi.debut) return false;
            const date = new Date(tournoi.debut);
            return getSeasonForDate(date) === currentSeason;
          });

          const totalSeason = seasonInscriptions.length;
          const convoquesSeason = seasonInscriptions.filter(i => i.convoque === 1).length;
          const forfaitsSeason = seasonInscriptions.filter(i => i.forfait === 1).length;

          // Update section title with season
          document.getElementById('inscSectionTitle').textContent = `Inscriptions saison ${currentSeason}`;

          // Update values
          document.getElementById('inscTotalSeason').textContent = totalSeason;
          document.getElementById('inscConvoquesSeason').textContent = convoquesSeason;
          document.getElementById('inscForfaitsSeason').textContent = forfaitsSeason;
        }
      } catch (error) {
        console.error('Error loading inscriptions stats:', error);
      }
    }

    // Load tournois stats (current season only)
    async function loadTournoisStats() {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournois-ext`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const tournois = await response.json();
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // Current season stats
          const currentSeason = getSeasonForDate(new Date());
          const seasonTournois = tournois.filter(t => {
            if (!t.debut) return false;
            const date = new Date(t.debut);
            return getSeasonForDate(date) === currentSeason;
          });

          const totalSeason = seasonTournois.length;
          const upcomingSeason = seasonTournois.filter(t => {
            const debut = t.debut ? new Date(t.debut) : null;
            return debut && debut >= today;
          }).length;
          const pastSeason = seasonTournois.filter(t => {
            const debut = t.debut ? new Date(t.debut) : null;
            return debut && debut < today;
          }).length;

          // Update section title with season
          document.getElementById('tournoiSectionTitle').textContent = `CompÃ©titions saison ${currentSeason}`;

          // Update values
          document.getElementById('tournoiTotalSeason').textContent = totalSeason;
          document.getElementById('tournoiUpcomingSeason').textContent = upcomingSeason;
          document.getElementById('tournoiPastSeason').textContent = pastSeason;
        }
      } catch (error) {
        console.error('Error loading tournois stats:', error);
      }
    }

    loadDashboard();
  </script>
</body>
</html>
