<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/modern.css">
  <style>
    .page-header {
      margin-bottom: var(--space-xl);
    }

    .page-title {
      font-size: var(--text-3xl);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .page-subtitle {
      font-size: var(--text-base);
      color: var(--text-secondary);
      margin-top: var(--space-xs);
    }

    /* Compact Stats Bar */
    .stats-bar {
      display: flex;
      align-items: center;
      justify-content: space-around;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-md) var(--space-lg);
      margin-bottom: var(--space-lg);
    }

    .stats-bar-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .stats-bar-icon {
      font-size: var(--text-lg);
    }

    .stats-bar-value {
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-primary);
    }

    .stats-bar-label {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .stats-bar-divider {
      width: 1px;
      height: 32px;
      background: var(--border);
    }

    @media (max-width: 768px) {
      .stats-bar {
        flex-wrap: wrap;
        gap: var(--space-md);
      }
      .stats-bar-divider {
        display: none;
      }
      .stats-bar-item {
        flex: 1 1 45%;
        justify-content: center;
      }
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
    }

    .section-title {
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--text-primary);
    }

    .tournaments-section {
      margin-top: var(--space-xl);
    }

    /* Table improvements */
    .table-actions {
      display: flex;
      gap: var(--space-sm);
      justify-content: flex-end;
    }

    .btn-view {
      background: var(--success);
      color: white;
      border: none;
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-view:hover {
      background: #2DB14E;
      transform: translateY(-1px);
    }

    .btn-delete-small {
      background: var(--danger-light);
      color: var(--danger);
      border: none;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-delete-small:hover {
      background: var(--danger);
      color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .welcome-banner {
        padding: var(--space-lg);
      }

      .welcome-banner h2 {
        font-size: var(--text-xl);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Navigation Header -->
    <nav class="nav-header">
      <div class="nav-brand">
        <img src="images/billiard-icon.png" alt="CDBHS" class="nav-brand-logo" onerror="this.style.display='none';">
        <div class="nav-brand-text">
          <span class="nav-brand-title">CDBHS</span>
          <span class="nav-brand-subtitle">Joueurs et CompÃ©titions</span>
        </div>
      </div>

      <div class="nav-links">
        <a href="dashboard.html" class="nav-link active">
          <span class="nav-link-icon">ğŸ </span>
          Accueil
        </a>

        <div class="nav-dropdown">
          <button class="nav-link">
            <span class="nav-link-icon">ğŸ“</span>
            Fichiers
          </button>
          <div class="nav-dropdown-menu">
            <a href="players-list.html" class="nav-dropdown-item">
              <span>ğŸ‘¥</span> Joueurs
            </a>
            <a href="tournaments-list.html" class="nav-dropdown-item">
              <span>ğŸ†</span> Tournois jouÃ©s
            </a>
            <a href="tournois-list.html" class="nav-dropdown-item">
              <span>ğŸ“‹</span> Tournois IONOS
            </a>
            <a href="inscriptions-list.html" class="nav-dropdown-item">
              <span>âœï¸</span> Inscriptions IONOS
            </a>
            <a href="clubs.html" class="nav-dropdown-item">
              <span>ğŸ¢</span> Clubs
            </a>
            <div class="nav-dropdown-divider admin-only"></div>
            <a href="import-players.html" class="nav-dropdown-item admin-only">
              <span>ğŸ“¥</span> Import Joueurs
            </a>
            <a href="import-tournament.html" class="nav-dropdown-item admin-only">
              <span>ğŸ“¤</span> Import Tournoi
            </a>
            <a href="import-external.html" class="nav-dropdown-item admin-only">
              <span>ğŸ“‹</span> Import Inscriptions
            </a>
          </div>
        </div>

        <a href="rankings.html" class="nav-link">
          <span class="nav-link-icon">ğŸ“Š</span>
          Classements
        </a>

        <a href="generate-poules.html" class="nav-link">
          <span class="nav-link-icon">ğŸ¯</span>
          Tournois Ã  jouer
        </a>

        <div class="nav-dropdown">
          <button class="nav-link">
            <span class="nav-link-icon">âš™ï¸</span>
            ParamÃ¨tres
          </button>
          <div class="nav-dropdown-menu">
            <a href="settings.html" class="nav-dropdown-item">
              <span>âš™ï¸</span> Configuration
            </a>
            <a href="calendar.html" class="nav-dropdown-item">
              <span>ğŸ“…</span> Calendrier
            </a>
          </div>
        </div>

        <a href="#" id="logoutBtn" class="nav-link nav-logout">
          <span class="nav-link-icon">ğŸšª</span>
          DÃ©connexion
        </a>

        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
          <span class="theme-toggle-icon">ğŸŒ™</span>
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="page-container animate-fadeIn">
      <!-- Alerts -->
      <div id="errorMessage" class="alert alert-danger" style="display: none;">
        <span class="alert-icon">âš ï¸</span>
        <span id="errorText"></span>
      </div>
      <div id="successMessage" class="alert alert-success" style="display: none;">
        <span class="alert-icon">âœ…</span>
        <span id="successText"></span>
      </div>

      <!-- Compact Stats Bar -->
      <div class="stats-bar">
        <div class="stats-bar-item">
          <span class="stats-bar-icon">ğŸ‘¥</span>
          <span class="stats-bar-value" id="activePlayerCount">-</span>
          <span class="stats-bar-label">Joueurs actifs</span>
        </div>
        <div class="stats-bar-divider"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-icon">ğŸ±</span>
          <span class="stats-bar-value" id="totalPlayerCount">-</span>
          <span class="stats-bar-label">Total joueurs</span>
        </div>
        <div class="stats-bar-divider"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-icon">ğŸ†</span>
          <span class="stats-bar-value" id="tournamentCount">-</span>
          <span class="stats-bar-label">CompÃ©titions</span>
        </div>
        <div class="stats-bar-divider"></div>
        <div class="stats-bar-item">
          <span class="stats-bar-icon">ğŸ“Š</span>
          <span class="stats-bar-value">13</span>
          <span class="stats-bar-label">CatÃ©gories</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Actions Rapides</h3>
        </div>
        <div class="quick-actions">
          <a href="players-list.html" class="quick-action-card">
            <div class="quick-action-icon">ğŸ‘¥</div>
            <span class="quick-action-label">Liste des Joueurs</span>
          </a>
          <a href="import-tournament.html" class="quick-action-card admin-only">
            <div class="quick-action-icon">ğŸ“¤</div>
            <span class="quick-action-label">Importer un Tournoi</span>
          </a>
          <a href="rankings.html" class="quick-action-card">
            <div class="quick-action-icon">ğŸ“Š</div>
            <span class="quick-action-label">Voir les Classements</span>
          </a>
          <a href="generate-poules.html" class="quick-action-card">
            <div class="quick-action-icon">ğŸ¯</div>
            <span class="quick-action-label">GÃ©nÃ©rer les Poules</span>
          </a>
        </div>
      </div>

      <!-- Recent Tournaments -->
      <div class="card tournaments-section">
        <div class="card-header">
          <h3 class="card-title">Derniers Tournois ImportÃ©s</h3>
          <a href="tournaments-list.html" class="btn btn-ghost btn-sm">Voir tout â†’</a>
        </div>

        <div id="loadingTournaments" class="loading">
          <div class="spinner"></div>
          <p>Chargement des tournois...</p>
        </div>

        <div id="tournamentsTable" style="display: none;">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>CatÃ©gorie</th>
                  <th>Tournoi</th>
                  <th>Saison</th>
                  <th>Participants</th>
                  <th>Date</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="tournamentsBody"></tbody>
            </table>
          </div>
        </div>

        <div id="emptyTournaments" class="empty-state" style="display: none;">
          <div class="empty-state-icon">ğŸ†</div>
          <h4 class="empty-state-title">Aucun tournoi importÃ©</h4>
          <p class="empty-state-text">Commencez par importer un tournoi pour voir les rÃ©sultats ici.</p>
          <a href="import-tournament.html" class="btn admin-only">Importer un tournoi</a>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_URL = '/api';

    // Theme management
    function getPreferredTheme() {
      const stored = localStorage.getItem('theme');
      if (stored) return stored;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeIcon(theme);
    }

    function updateThemeIcon(theme) {
      const icon = document.querySelector('.theme-toggle-icon');
      if (icon) icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      setTheme(current === 'dark' ? 'light' : 'dark');
    }

    // Initialize theme
    setTheme(getPreferredTheme());

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and show/hide admin elements
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load player counts
        const allPlayersResponse = await fetch(`${API_URL}/players`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (allPlayersResponse.status === 401 || allPlayersResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (allPlayersResponse.ok) {
          const allPlayers = await allPlayersResponse.json();
          const activePlayers = allPlayers.filter(p => p.is_active === 1);
          document.getElementById('activePlayerCount').textContent = activePlayers.length;
          document.getElementById('totalPlayerCount').textContent = allPlayers.length;
        }

        // Load tournaments
        const tournamentsResponse = await fetch(`${API_URL}/tournaments`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (tournamentsResponse.status === 401 || tournamentsResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          document.getElementById('tournamentCount').textContent = tournaments.length;

          // Sort by date (newest first)
          tournaments.sort((a, b) => {
            const dateA = new Date(a.tournament_date || a.import_date);
            const dateB = new Date(b.tournament_date || b.import_date);
            return dateB - dateA;
          });

          const recentTournaments = tournaments.slice(0, 5);
          const tbody = document.getElementById('tournamentsBody');
          tbody.innerHTML = '';

          document.getElementById('loadingTournaments').style.display = 'none';

          if (recentTournaments.length === 0) {
            document.getElementById('emptyTournaments').style.display = 'flex';
          } else {
            document.getElementById('tournamentsTable').style.display = 'block';

            recentTournaments.forEach(tournament => {
              const row = document.createElement('tr');
              row.className = 'table-row-clickable';
              const tournamentLabel = tournament.tournament_number === 4 ? 'Finale' : `T${tournament.tournament_number}`;

              const deleteBtn = userRole === 'admin'
                ? `<button class="btn-delete-small" data-tournament-id="${tournament.id}" title="Supprimer">ğŸ—‘ï¸</button>`
                : '';

              row.innerHTML = `
                <td><span class="badge badge-primary">${tournament.display_name}</span></td>
                <td><strong>${tournamentLabel}</strong></td>
                <td>${tournament.season}</td>
                <td>${tournament.player_count} joueurs</td>
                <td>${tournament.tournament_date ? new Date(tournament.tournament_date).toLocaleDateString('fr-FR') : '-'}</td>
                <td>
                  <div class="table-actions">
                    <button class="btn-view" data-tournament-id="${tournament.id}">Voir</button>
                    ${deleteBtn}
                  </div>
                </td>
              `;

              // Row click (except actions column)
              row.addEventListener('click', (e) => {
                if (!e.target.closest('.table-actions')) {
                  window.location.href = `rankings.html?categoryId=${tournament.category_id}&season=${encodeURIComponent(tournament.season)}`;
                }
              });

              // View button
              row.querySelector('.btn-view').addEventListener('click', (e) => {
                e.stopPropagation();
                window.location.href = `tournament-results.html?id=${tournament.id}`;
              });

              // Delete button
              const deleteBtnEl = row.querySelector('.btn-delete-small');
              if (deleteBtnEl) {
                deleteBtnEl.addEventListener('click', async (e) => {
                  e.stopPropagation();
                  if (confirm(`Supprimer "${tournament.display_name} - T${tournament.tournament_number}" ?\n\nCette action recalculera les classements.`)) {
                    await deleteTournament(tournament.id);
                  }
                });
              }

              tbody.appendChild(row);
            });
          }
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('loadingTournaments').innerHTML = '<p class="text-danger">Erreur de chargement</p>';
      }
    }

    // Delete tournament
    async function deleteTournament(tournamentId) {
      try {
        const response = await fetch(`${API_URL}/tournaments/${tournamentId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const successDiv = document.getElementById('successMessage');
          const successText = document.getElementById('successText');
          successText.textContent = 'Tournoi supprimÃ© avec succÃ¨s !';
          successDiv.style.display = 'flex';
          setTimeout(() => successDiv.style.display = 'none', 3000);
          loadDashboard();
        } else {
          const data = await response.json();
          alert(`Erreur: ${data.error || 'Erreur inconnue'}`);
        }
      } catch (error) {
        console.error('Error deleting tournament:', error);
        alert('Erreur de connexion');
      }
    }

    loadDashboard();
  </script>
</body>
</html>
